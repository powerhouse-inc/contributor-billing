import { useState, useMemo } from "react";
import { generateId } from "document-model/core";
import type { DocumentDispatch } from "@powerhousedao/reactor-browser";
import type {
  ServiceOfferingDocument,
  ServiceOfferingAction,
  Service,
} from "services/document-models/service-offering";
import {
  addService,
  updateService,
  deleteService,
} from "../../../document-models/service-offering/gen/creators.js";

interface ServiceCatalogProps {
  document: ServiceOfferingDocument;
  dispatch: DocumentDispatch<ServiceOfferingAction>;
}

// Service groups are a UI concept to organize services
// In a real implementation, this could be stored as an optionGroup on services
interface ServiceGroup {
  id: string;
  name: string;
  serviceIds: string[];
}

export function ServiceCatalog({ document, dispatch }: ServiceCatalogProps) {
  const { state } = document;
  const services = state.global.services ?? [];

  // Local state for service groups (UI organization)
  const [groups, setGroups] = useState<ServiceGroup[]>([
    { id: "included", name: "Included Services", serviceIds: [] },
  ]);
  const [selectedGroupId, setSelectedGroupId] = useState<string>("included");
  const [isAddingService, setIsAddingService] = useState(false);
  const [isAddingGroup, setIsAddingGroup] = useState(false);
  const [newGroupName, setNewGroupName] = useState("");
  const [newService, setNewService] = useState({ title: "", description: "" });

  // Get services for the selected group
  const selectedGroup = groups.find((g) => g.id === selectedGroupId);
  const groupServices = useMemo(() => {
    if (!selectedGroup) return [];
    // For now, show all services if no specific assignment
    if (selectedGroup.serviceIds.length === 0) {
      return services;
    }
    return services.filter((s) => selectedGroup.serviceIds.includes(s.id));
  }, [selectedGroup, services]);

  const handleAddGroup = () => {
    if (!newGroupName.trim()) return;
    const newGroup: ServiceGroup = {
      id: generateId(),
      name: newGroupName.trim(),
      serviceIds: [],
    };
    setGroups([...groups, newGroup]);
    setNewGroupName("");
    setIsAddingGroup(false);
  };

  const handleAddService = () => {
    if (!newService.title.trim()) return;

    const serviceId = generateId();
    dispatch(
      addService({
        id: serviceId,
        title: newService.title.trim(),
        description: newService.description.trim() || undefined,
        lastModified: new Date().toISOString(),
      })
    );

    // Add to current group
    if (selectedGroup) {
      setGroups(
        groups.map((g) =>
          g.id === selectedGroupId
            ? { ...g, serviceIds: [...g.serviceIds, serviceId] }
            : g
        )
      );
    }

    setNewService({ title: "", description: "" });
    setIsAddingService(false);
  };

  const handleUpdateService = (service: Service, field: "title" | "description", value: string) => {
    dispatch(
      updateService({
        id: service.id,
        [field]: value || undefined,
        lastModified: new Date().toISOString(),
      })
    );
  };

  const handleDeleteService = (serviceId: string) => {
    if (!confirm("Are you sure you want to delete this service?")) return;
    dispatch(
      deleteService({
        id: serviceId,
        lastModified: new Date().toISOString(),
      })
    );
    // Remove from all groups
    setGroups(
      groups.map((g) => ({
        ...g,
        serviceIds: g.serviceIds.filter((id) => id !== serviceId),
      }))
    );
  };

  return (
    <div className="flex gap-6 h-full">
      {/* Service Groups Sidebar */}
      <div className="w-80 bg-white rounded-lg shadow-sm p-4 flex-shrink-0">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-gray-900">Service Groups</h2>
          <button
            onClick={() => setIsAddingGroup(true)}
            className="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>

        {isAddingGroup && (
          <div className="mb-4 p-3 bg-gray-50 rounded-lg">
            <input
              type="text"
              value={newGroupName}
              onChange={(e) => setNewGroupName(e.target.value)}
              placeholder="Group name..."
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm mb-2"
              autoFocus
            />
            <div className="flex gap-2">
              <button
                onClick={handleAddGroup}
                disabled={!newGroupName.trim()}
                className="flex-1 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Add
              </button>
              <button
                onClick={() => {
                  setIsAddingGroup(false);
                  setNewGroupName("");
                }}
                className="flex-1 px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300"
              >
                Cancel
              </button>
            </div>
          </div>
        )}

        <div className="space-y-1">
          {groups.map((group) => {
            const groupServiceCount = group.serviceIds.length || services.length;
            return (
              <button
                key={group.id}
                onClick={() => setSelectedGroupId(group.id)}
                className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${
                  selectedGroupId === group.id
                    ? "bg-blue-50 border-l-4 border-blue-500"
                    : "hover:bg-gray-50"
                }`}
              >
                <div className="font-medium text-gray-900">{group.name}</div>
                <div className="text-sm text-gray-500">
                  {groupServiceCount} service{groupServiceCount !== 1 ? "s" : ""}
                </div>
              </button>
            );
          })}
        </div>
      </div>

      {/* Services List */}
      <div className="flex-1 bg-white rounded-lg shadow-sm p-6">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-semibold text-gray-900">
            Services in "{selectedGroup?.name || "All Services"}"
          </h2>
          <button
            onClick={() => setIsAddingService(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
            Add Service
          </button>
        </div>

        {isAddingService && (
          <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Service Name
                </label>
                <input
                  type="text"
                  value={newService.title}
                  onChange={(e) => setNewService({ ...newService, title: e.target.value })}
                  placeholder="Enter service name..."
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg"
                  autoFocus
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  Description
                </label>
                <textarea
                  value={newService.description}
                  onChange={(e) => setNewService({ ...newService, description: e.target.value })}
                  placeholder="Enter description..."
                  rows={2}
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg resize-none"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={handleAddService}
                  disabled={!newService.title.trim()}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  Add Service
                </button>
                <button
                  onClick={() => {
                    setIsAddingService(false);
                    setNewService({ title: "", description: "" });
                  }}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {groupServices.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            <svg
              className="w-12 h-12 mx-auto mb-4 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <p className="text-lg font-medium mb-1">No services yet</p>
            <p className="text-sm">Click "Add Service" to create your first service.</p>
          </div>
        ) : (
          <div className="space-y-4">
            {groupServices.map((service) => (
              <ServiceCard
                key={service.id}
                service={service}
                onUpdate={handleUpdateService}
                onDelete={() => handleDeleteService(service.id)}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

interface ServiceCardProps {
  service: Service;
  onUpdate: (service: Service, field: "title" | "description", value: string) => void;
  onDelete: () => void;
}

function ServiceCard({ service, onUpdate, onDelete }: ServiceCardProps) {
  const [localTitle, setLocalTitle] = useState(service.title);
  const [localDescription, setLocalDescription] = useState(service.description || "");

  return (
    <div className="p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors">
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 space-y-3">
          <div>
            <label className="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
              Service Name
            </label>
            <input
              type="text"
              value={localTitle}
              onChange={(e) => setLocalTitle(e.target.value)}
              onBlur={() => {
                if (localTitle !== service.title) {
                  onUpdate(service, "title", localTitle);
                }
              }}
              className="w-full text-lg font-medium text-gray-900 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none pb-1"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
              Description
            </label>
            <textarea
              value={localDescription}
              onChange={(e) => setLocalDescription(e.target.value)}
              onBlur={() => {
                if (localDescription !== (service.description || "")) {
                  onUpdate(service, "description", localDescription);
                }
              }}
              placeholder="Add a description..."
              rows={2}
              className="w-full text-gray-600 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
        <button
          onClick={onDelete}
          className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
        </button>
      </div>
    </div>
  );
}
