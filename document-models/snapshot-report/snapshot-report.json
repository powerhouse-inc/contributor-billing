{
    "id": "powerhouse/snapshot-report",
    "name": "Snapshot Report",
    "extension": "phsr",
    "description": "Document model for creating snapshot reports that track fund flows through categorized accounts over a specified accounting period",
    "author": {
        "name": "Powerhouse",
        "website": "https://www.powerhouse.inc/"
    },
    "specifications": [
        {
            "version": 1,
            "changeLog": [],
            "state": {
                "global": {
                    "schema": "type SnapshotReportState {\n  accountsDocumentId: PHID\n  startDate: DateTime\n  endDate: DateTime\n  reportName: String\n  snapshotAccounts: [SnapshotAccount!]!\n}\n\ntype SnapshotAccount {\n  id: OID!\n  accountId: OID!\n  accountAddress: String!\n  accountName: String!\n  type: AccountType!\n  accountTransactionsId: PHID\n  startingBalances: [TokenBalance!]!\n  endingBalances: [TokenBalance!]!\n  transactions: [SnapshotTransaction!]!\n}\n\ntype TokenBalance {\n  id: OID!\n  token: Currency!\n  amount: Amount_Currency!\n}\n\ntype SnapshotTransaction {\n  id: OID!\n  transactionId: String!\n  counterParty: EthereumAddress\n  amount: Amount_Currency!\n  datetime: DateTime!\n  txHash: String!\n  token: Currency!\n  blockNumber: Int\n  direction: TransactionDirection!\n  flowType: TransactionFlowType\n  counterPartyAccountId: OID\n}\n\nenum AccountType {\n  Source\n  Internal\n  Destination\n  External\n}\n\nenum AccountTypeInput {\n  Source\n  Internal\n  Destination\n  External\n}\n\nenum TransactionDirection {\n  INFLOW\n  OUTFLOW\n}\n\nenum TransactionDirectionInput {\n  INFLOW\n  OUTFLOW\n}\n\nenum TransactionFlowType {\n  TopUp\n  Return\n  Internal\n  External\n}\n\nenum TransactionFlowTypeInput {\n  TopUp\n  Return\n  Internal\n  External\n}",
                    "initialValue": "{\n  \"accountsDocumentId\": null,\n  \"startDate\": null,\n  \"endDate\": null,\n  \"reportName\": null,\n  \"snapshotAccounts\": []\n}",
                    "examples": []
                },
                "local": {
                    "schema": "",
                    "initialValue": "",
                    "examples": []
                }
            },
            "modules": [
                {
                    "id": "config",
                    "name": "configuration",
                    "description": "Operations for configuring the snapshot report",
                    "operations": [
                        {
                            "id": "set-report-config",
                            "name": "SET_REPORT_CONFIG",
                            "description": "Set the report configuration including name, period, and accounts document reference",
                            "schema": "input SetReportConfigInput {\n  reportName: String\n  startDate: DateTime\n  endDate: DateTime\n  accountsDocumentId: PHID\n}",
                            "template": "Set the report configuration including name, period, and accounts document reference",
                            "reducer": "if (action.input.reportName !== undefined && action.input.reportName !== null) {\n  state.reportName = action.input.reportName;\n}\nif (action.input.startDate !== undefined && action.input.startDate !== null) {\n  state.startDate = action.input.startDate;\n}\nif (action.input.endDate !== undefined && action.input.endDate !== null) {\n  state.endDate = action.input.endDate;\n}\nif (action.input.accountsDocumentId !== undefined && action.input.accountsDocumentId !== null) {\n  state.accountsDocumentId = action.input.accountsDocumentId;\n}",
                            "errors": [],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "set-accounts-document",
                            "name": "SET_ACCOUNTS_DOCUMENT",
                            "description": "Link the snapshot report to an Accounts document",
                            "schema": "input SetAccountsDocumentInput {\n  accountsDocumentId: PHID!\n}",
                            "template": "Link the snapshot report to an Accounts document",
                            "reducer": "state.accountsDocumentId = action.input.accountsDocumentId;",
                            "errors": [],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "set-period",
                            "name": "SET_PERIOD",
                            "description": "Set the accounting period for the snapshot report",
                            "schema": "input SetPeriodInput {\n  startDate: DateTime!\n  endDate: DateTime!\n}",
                            "template": "Set the accounting period for the snapshot report",
                            "reducer": "state.startDate = action.input.startDate;\nstate.endDate = action.input.endDate;",
                            "errors": [],
                            "examples": [],
                            "scope": "global"
                        }
                    ]
                },
                {
                    "id": "accounts",
                    "name": "accounts",
                    "description": "Operations for managing snapshot accounts",
                    "operations": [
                        {
                            "id": "add-snapshot-account",
                            "name": "ADD_SNAPSHOT_ACCOUNT",
                            "description": "Add an account to the snapshot report",
                            "schema": "input AddSnapshotAccountInput {\n  id: OID!\n  accountId: OID!\n  accountAddress: String!\n  accountName: String!\n  type: AccountTypeInput!\n  accountTransactionsId: PHID\n}",
                            "template": "Add an account to the snapshot report",
                            "reducer": "const existingAccount = state.snapshotAccounts.find(a => a.id === action.input.id);\nif (existingAccount) {\n  throw new DuplicateAccountError(`Account with ID ${action.input.id} already exists`);\n}\n\nconst newAccount = {\n  id: action.input.id,\n  accountId: action.input.accountId,\n  accountAddress: action.input.accountAddress,\n  accountName: action.input.accountName,\n  type: action.input.type,\n  accountTransactionsId: action.input.accountTransactionsId || null,\n  startingBalances: [],\n  endingBalances: [],\n  transactions: []\n};\n\nstate.snapshotAccounts.push(newAccount);",
                            "errors": [
                                {
                                    "id": "duplicate-account-error",
                                    "name": "DuplicateAccountError",
                                    "code": "DUPLICATE_ACCOUNT",
                                    "description": "An account with this ID already exists in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "update-account-type",
                            "name": "UPDATE_SNAPSHOT_ACCOUNT_TYPE",
                            "description": "Update the type categorization of a snapshot account",
                            "schema": "input UpdateSnapshotAccountTypeInput {\n  id: OID!\n  type: AccountTypeInput!\n}",
                            "template": "Update the type categorization of a snapshot account",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.id);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.id} not found`);\n}\n\naccount.type = action.input.type;",
                            "errors": [
                                {
                                    "id": "account-not-found-error",
                                    "name": "AccountNotFoundError",
                                    "code": "ACCOUNT_NOT_FOUND",
                                    "description": "The specified account was not found in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "remove-snapshot-account",
                            "name": "REMOVE_SNAPSHOT_ACCOUNT",
                            "description": "Remove an account from the snapshot report",
                            "schema": "input RemoveSnapshotAccountInput {\n  id: OID!\n}",
                            "template": "Remove an account from the snapshot report",
                            "reducer": "const accountIndex = state.snapshotAccounts.findIndex(a => a.id === action.input.id);\nif (accountIndex === -1) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.id} not found`);\n}\n\nstate.snapshotAccounts.splice(accountIndex, 1);",
                            "errors": [
                                {
                                    "id": "account-not-found-error-2",
                                    "name": "AccountNotFoundError",
                                    "code": "ACCOUNT_NOT_FOUND",
                                    "description": "The specified account was not found in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        }
                    ]
                },
                {
                    "id": "balances",
                    "name": "balances",
                    "description": "Operations for managing account token balances",
                    "operations": [
                        {
                            "id": "set-starting-balance",
                            "name": "SET_STARTING_BALANCE",
                            "description": "Set or update a starting balance for a token in a snapshot account",
                            "schema": "input SetStartingBalanceInput {\n  accountId: OID!\n  balanceId: OID!\n  token: Currency!\n  amount: Amount_Currency!\n}",
                            "template": "Set or update a starting balance for a token in a snapshot account",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.accountId);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.accountId} not found`);\n}\n\nconst existingBalance = account.startingBalances.find(b => b.id === action.input.balanceId);\nif (existingBalance) {\n  existingBalance.token = action.input.token;\n  existingBalance.amount = action.input.amount;\n} else {\n  account.startingBalances.push({\n    id: action.input.balanceId,\n    token: action.input.token,\n    amount: action.input.amount\n  });\n}",
                            "errors": [
                                {
                                    "id": "account-not-found-error-3",
                                    "name": "AccountNotFoundError",
                                    "code": "ACCOUNT_NOT_FOUND",
                                    "description": "The specified account was not found in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "set-ending-balance",
                            "name": "SET_ENDING_BALANCE",
                            "description": "Set or update an ending balance for a token in a snapshot account",
                            "schema": "input SetEndingBalanceInput {\n  accountId: OID!\n  balanceId: OID!\n  token: Currency!\n  amount: Amount_Currency!\n}",
                            "template": "Set or update an ending balance for a token in a snapshot account",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.accountId);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.accountId} not found`);\n}\n\nconst existingBalance = account.endingBalances.find(b => b.id === action.input.balanceId);\nif (existingBalance) {\n  existingBalance.token = action.input.token;\n  existingBalance.amount = action.input.amount;\n} else {\n  account.endingBalances.push({\n    id: action.input.balanceId,\n    token: action.input.token,\n    amount: action.input.amount\n  });\n}",
                            "errors": [
                                {
                                    "id": "account-not-found-error-4",
                                    "name": "AccountNotFoundError",
                                    "code": "ACCOUNT_NOT_FOUND",
                                    "description": "The specified account was not found in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "remove-starting-balance",
                            "name": "REMOVE_STARTING_BALANCE",
                            "description": "Remove a starting balance entry from a snapshot account",
                            "schema": "input RemoveStartingBalanceInput {\n  accountId: OID!\n  balanceId: OID!\n}",
                            "template": "Remove a starting balance entry from a snapshot account",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.accountId);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.accountId} not found`);\n}\n\nconst balanceIndex = account.startingBalances.findIndex(b => b.id === action.input.balanceId);\nif (balanceIndex === -1) {\n  throw new BalanceNotFoundError(`Balance with ID ${action.input.balanceId} not found`);\n}\n\naccount.startingBalances.splice(balanceIndex, 1);",
                            "errors": [
                                {
                                    "id": "balance-not-found-error",
                                    "name": "BalanceNotFoundError",
                                    "code": "BALANCE_NOT_FOUND",
                                    "description": "The specified balance was not found",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "remove-ending-balance",
                            "name": "REMOVE_ENDING_BALANCE",
                            "description": "Remove an ending balance entry from a snapshot account",
                            "schema": "input RemoveEndingBalanceInput {\n  accountId: OID!\n  balanceId: OID!\n}",
                            "template": "Remove an ending balance entry from a snapshot account",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.accountId);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.accountId} not found`);\n}\n\nconst balanceIndex = account.endingBalances.findIndex(b => b.id === action.input.balanceId);\nif (balanceIndex === -1) {\n  throw new BalanceNotFoundError(`Balance with ID ${action.input.balanceId} not found`);\n}\n\naccount.endingBalances.splice(balanceIndex, 1);",
                            "errors": [
                                {
                                    "id": "balance-not-found-error-2",
                                    "name": "BalanceNotFoundError",
                                    "code": "BALANCE_NOT_FOUND",
                                    "description": "The specified balance was not found",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        }
                    ]
                },
                {
                    "id": "transactions",
                    "name": "transactions",
                    "description": "Operations for managing snapshot transactions",
                    "operations": [
                        {
                            "id": "add-transaction",
                            "name": "ADD_TRANSACTION",
                            "description": "Add a transaction to the snapshot with enrichment data",
                            "schema": "input AddTransactionInput {\n  accountId: OID!\n  id: OID!\n  transactionId: String!\n  counterParty: EthereumAddress\n  amount: Amount_Currency!\n  datetime: DateTime!\n  txHash: String!\n  token: Currency!\n  blockNumber: Int\n  direction: TransactionDirectionInput!\n  flowType: TransactionFlowTypeInput\n  counterPartyAccountId: OID\n}\n",
                            "template": "Add a transaction to the snapshot with enrichment data",
                            "reducer": "const account = state.snapshotAccounts.find(a => a.id === action.input.accountId);\nif (!account) {\n  throw new AccountNotFoundError(`Account with ID ${action.input.accountId} not found`);\n}\n\nconst existingTransaction = account.transactions.find(t => t.id === action.input.id);\nif (existingTransaction) {\n  throw new DuplicateTransactionError(`Transaction with ID ${action.input.id} already exists`);\n}\n\nconst newTransaction = {\n  id: action.input.id,\n  transactionId: action.input.transactionId,\n  counterParty: action.input.counterParty || null,\n  amount: action.input.amount,\n  datetime: action.input.datetime,\n  txHash: action.input.txHash,\n  token: action.input.token,\n  blockNumber: action.input.blockNumber || null,\n  direction: action.input.direction,\n  flowType: action.input.flowType || null,\n  counterPartyAccountId: action.input.counterPartyAccountId || null\n};\n\naccount.transactions.push(newTransaction);",
                            "errors": [
                                {
                                    "id": "duplicate-transaction-error",
                                    "name": "DuplicateTransactionError",
                                    "code": "DUPLICATE_TRANSACTION",
                                    "description": "A transaction with this ID already exists in the snapshot",
                                    "template": ""
                                },
                                {
                                    "id": "account-not-found-error-5",
                                    "name": "AccountNotFoundError",
                                    "code": "ACCOUNT_NOT_FOUND",
                                    "description": "The specified account was not found in the snapshot",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "remove-transaction",
                            "name": "REMOVE_TRANSACTION",
                            "description": "Remove a transaction from the snapshot",
                            "schema": "input RemoveTransactionInput {\n  id: OID!\n}",
                            "template": "Remove a transaction from the snapshot",
                            "reducer": "let found = false;\n\nfor (const account of state.snapshotAccounts) {\n  const transactionIndex = account.transactions.findIndex(t => t.id === action.input.id);\n  if (transactionIndex !== -1) {\n    account.transactions.splice(transactionIndex, 1);\n    found = true;\n    break;\n  }\n}\n\nif (!found) {\n  throw new TransactionNotFoundError(`Transaction with ID ${action.input.id} not found`);\n}",
                            "errors": [
                                {
                                    "id": "transaction-not-found-error",
                                    "name": "TransactionNotFoundError",
                                    "code": "TRANSACTION_NOT_FOUND",
                                    "description": "The specified transaction was not found",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        },
                        {
                            "id": "update-flow-type",
                            "name": "UPDATE_TRANSACTION_FLOW_TYPE",
                            "description": "Update the flow type categorization of a transaction",
                            "schema": "input UpdateTransactionFlowTypeInput {\n  id: OID!\n  flowType: TransactionFlowTypeInput!\n}",
                            "template": "Update the flow type categorization of a transaction",
                            "reducer": "let transaction = null;\n\nfor (const account of state.snapshotAccounts) {\n  transaction = account.transactions.find(t => t.id === action.input.id);\n  if (transaction) {\n    break;\n  }\n}\n\nif (!transaction) {\n  throw new TransactionNotFoundError(`Transaction with ID ${action.input.id} not found`);\n}\n\ntransaction.flowType = action.input.flowType;",
                            "errors": [
                                {
                                    "id": "transaction-not-found-error-2",
                                    "name": "TransactionNotFoundError",
                                    "code": "TRANSACTION_NOT_FOUND",
                                    "description": "The specified transaction was not found",
                                    "template": ""
                                }
                            ],
                            "examples": [],
                            "scope": "global"
                        }
                    ]
                }
            ]
        }
    ]
}